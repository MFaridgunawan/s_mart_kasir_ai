<!DOCTYPE html>
<html lang="id">
<head>
    <title>Laporan Keuangan - S-Mart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 font-sans">

<nav class="bg-indigo-600 shadow-lg mb-8 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                    <i class="bi bi-shield-lock-fill text-white text-xl"></i>
                </div>
                <span class="text-white text-xl font-bold tracking-tight">ADMIN CONSOLE</span>
            </div>
            
            <div class="flex gap-3">
                <a href="/admin" class="bg-indigo-700 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 text-sm border border-indigo-500/30 shadow-sm">
                    <i class="bi bi-speedometer2"></i> Antrian
                </a>

                <a href="/inventory" class="bg-indigo-700/50 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 text-sm border border-indigo-500/30">
                    <i class="bi bi-box-seam"></i> Stok
                </a>

                <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 text-sm shadow-sm border border-red-400 ml-2">
                    <i class="bi bi-box-arrow-right"></i> Keluar
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 pb-12 fade-in">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2 mb-2">
            <i class="bi bi-journal-text text-indigo-600"></i> Laporan Keuangan
        </h1>
        <p class="text-gray-600">Rekapitulasi transaksi harian & Omzet</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gradient-to-br from-indigo-600 to-blue-600 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-32 bg-white opacity-10 transform skew-x-12"></div>
            <div class="relative z-10">
                <p class="text-indigo-100 text-sm font-bold uppercase tracking-wide mb-1">TOTAL OMZET (PAID)</p>
                <h2 class="text-4xl font-bold">Rp {{ "{:,.0f}".format(omzet).replace(',', '.') }}</h2>
            </div>
            <i class="bi bi-graph-up-arrow absolute bottom-4 right-4 text-6xl text-white opacity-20"></i>
        </div>
        
        <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-bold uppercase tracking-wide mb-1">TOTAL TRANSAKSI</p>
                <h2 class="text-4xl font-bold text-gray-800">{{ count }} <span class="text-lg text-gray-400 font-medium">struk</span></h2>
            </div>
            <div class="bg-gray-100 p-4 rounded-full">
                <i class="bi bi-receipt text-3xl text-gray-400"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-900 text-white">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">ID</th>
                        <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Waktu</th>
                        <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Metode</th>
                        <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Item</th>
                        <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider">Total</th>
                        <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider">Masuk</th>
                        <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider">Kembali</th>
                        <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for t in transactions %}
                    <tr class="hover:bg-indigo-50/50 transition duration-150">
                        <td class="px-6 py-4 text-sm font-bold text-gray-700">#{{ t.id }}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">{{ t.timestamp.strftime('%d/%m %H:%M') }}</td>
                        <td class="px-6 py-4">
                            {% if t.payment_method == 'QRIS' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800 border border-blue-200">
                                    QRIS
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-emerald-100 text-emerald-800 border border-emerald-200">
                                    TUNAI
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate" title="{{ t.items_str }}">{{ t.items_str }}</td>
                        <td class="px-6 py-4 text-right text-sm font-bold text-gray-900">Rp {{ "{:,.0f}".format(t.total_price).replace(',', '.') }}</td>
                        <td class="px-6 py-4 text-right text-sm font-medium text-indigo-600">Rp {{ "{:,.0f}".format(t.cash_in).replace(',', '.') }}</td>
                        <td class="px-6 py-4 text-right text-sm font-medium text-red-500">Rp {{ "{:,.0f}".format(t.change).replace(',', '.') }}</td>
                        <td class="px-6 py-4 text-center flex justify-center gap-2">
                            <button onclick="editTrans('{{t.id}}', '{{t.payment_method}}')" class="bg-yellow-400 hover:bg-yellow-500 text-white w-8 h-8 rounded-lg flex items-center justify-center transition shadow-sm" title="Edit">
                                <i class="bi bi-pencil-fill text-xs"></i>
                            </button>
                            <button onclick="deleteTrans('{{t.id}}')" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-lg flex items-center justify-center transition shadow-sm" title="Hapus">
                                <i class="bi bi-trash-fill text-xs"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-400 bg-gray-50">
                            <i class="bi bi-inbox text-4xl block mb-2 opacity-50"></i>
                            Belum ada data transaksi.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
        <div class="bg-gray-900 text-white p-4 flex justify-between items-center">
            <h3 class="font-bold">Edit Transaksi</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <div class="p-6">
            <form id="editForm">
                <input type="hidden" id="edit-id" name="id">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Metode Pembayaran</label>
                    <select class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 outline-none" name="payment_method" id="edit-method">
                        <option value="TUNAI">TUNAI</option>
                        <option value="QRIS">QRIS</option>
                    </select>
                </div>
                <button type="button" onclick="saveEdit()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition">Simpan</button>
            </form>
        </div>
    </div>
</div>

<script>
    function deleteTrans(id) {
        Swal.fire({
            title: 'Hapus Data?', text: "Data tidak bisa dikembalikan!", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Hapus'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/delete_transaction/' + id, { method: 'POST' }).then(res => res.json()).then(data => {
                    if (data.status === 'success') location.reload();
                });
            }
        });
    }

    function editTrans(id, method) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-method').value = method;
        document.getElementById('editModal').classList.remove('hidden');
    }
    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

    function saveEdit() {
        const formData = new FormData(document.getElementById('editForm'));
        fetch('/update_transaction', { method: 'POST', body: formData }).then(res => res.json()).then(data => {
            if (data.status === 'success') location.reload();
        });
    }
</script>

</body>
</html>